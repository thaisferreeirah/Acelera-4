<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Acesso Escolar</title>
    <link rel="stylesheet" href="../static/fontawesome-free-6.7.2-web/css/all.min.css">
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        
        function renderRecognitionChart() {
            fetch('/histrectest') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Dados brutos do histórico recebidos:", data); 

                    const dailyCounts = {};
                    data.forEach(item => {
                        const date = item.date; 
                        dailyCounts[date] = (dailyCounts[date] || 0) + 1;
                    });

                    const sortedDates = Object.keys(dailyCounts).sort((a, b) => {
                        const [dA, mA, yA] = a.split('/');
                        const [dB, mB, yB] = b.split('/');
                        const dateA = new Date(`${yA}-${mA}-${dA}`);
                        const dateB = new Date(`${yB}-${mB}-${dB}`);
                        return dateA - dateB;
                    });

                    const labels = sortedDates;
                    const counts = sortedDates.map(date => dailyCounts[date]);

                    const ctx = document.getElementById('recognitionChart').getContext('2d');

                    new Chart(ctx, {
                        type: 'bar', 
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Reconhecimentos Diários',
                                data: counts,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)', 
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Quantidade'
                                    },
                                    ticks: {
                                        stepSize: 1, 
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Data'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Reconhecimentos por Dia'
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar dados do gráfico:', error);
                });
        }

        // Simula a tabela sendo preenchida
        document.addEventListener('DOMContentLoaded', function () {
            const recentAccessData = [
                { date: "10/05/2023 08:15", name: "João Silva", id: "2023001", type: "Entrada", method: "Facial" },
                { date: "10/05/2023 08:20", name: "Maria Oliveira", id: "2023002", type: "Entrada", method: "Facial" },
                { date: "10/05/2023 09:05", name: "Carlos Souza", id: "2023003", type: "Entrada", method: "Cartão" },
                { date: "10/05/2023 10:30", name: "Ana Costa", id: "2023004", type: "Saída", method: "Facial" },
                { date: "10/05/2023 11:45", name: "Pedro Santos", id: "2023005", type: "Entrada", method: "Facial" }
            ];

            const tableBody = document.getElementById('recentAccessTable');

            recentAccessData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.name}</td>
            <td>${item.id}</td>
            <td><span class="access-type ${item.type.toLowerCase()}">${item.type}</span></td>
            <td>${item.method}</td>
          `;
                tableBody.appendChild(row);
            });

            setTimeout(() => {
                document.querySelectorAll('.access-type').forEach(el => {
                    if (el.textContent === 'Entrada') {
                        el.classList.add('entrada');
                    } else {
                        el.classList.add('saida');
                    }
                });
            }, 600); 

            renderRecognitionChart(); 
        });

    </script>
</head>

<body>
    <div id="menu-container"></div>

    <main class="main-content">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-chart-line"></i> Resumo de Acessos</h2>
            </div>
            <p>Bem-vindo ao sistema de controle de acesso por reconhecimento facial.</p>

            <div class="face-recognition">
                <div class="video-container">
                    <canvas id="recognitionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-bell"></i> Últimos Acessos</h2>
                <a href="/historico">Ver todos</a>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Aluno</th>
                        <th>Matrícula</th>
                        <th>Tipo</th>
                        <th>Método</th>
                    </tr>
                </thead>
                <tbody id="recentAccessTable">
                    </tbody>
            </table>
        </div>
    </main>
    <script src="../static/js/script.js"></script>
</body>

</html>