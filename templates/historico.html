<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico - Controle de Acesso Escolar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../static/style.css">

</head>

<body>
    <div id="menu-container"></div>

    <main class="main-content">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-history"></i> Histórico de Acessos</h2>
                <div>
                    <h3 style="display: inline-block; width: auto; margin-right: 10px;">Filtro</h3>
                    <input type="text" id="filterName" placeholder="Nome" style="display: inline-block; width: auto;">
                    <input type="date" id="filterDate" class="form-control" style="display: inline-block; width: auto;">
                    <button class="btn btn-primary" onclick="resetFilter()">
                        <i class="fas fa-sync-alt"></i> Limpar
                    </button>
                </div>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Hora</th>
                        <th>Nome</th>
                        <th>Método</th>
                        <th>Descrição</th>
                    </tr>
                </thead>
                <tbody id="accessHistoryTable"></tbody>
            </table>
        </div>
    </main>

    <script>
        function carregarHistorico() {
            fetch("{{ url_for('recognitiontest.histrectest') }}")
                .then(response => response.json())
                .then(data => {
                    const tabela = document.getElementById("accessHistoryTable");
                    data.forEach(usuario => {
                        const linha = `<tr>
                            <td>${usuario.date ?? ""}</td>
                            <td>${usuario.time ?? ""}</td>
                            <td>${usuario.authorized_name ?? ""}</td>
                            <td>${usuario.method ?? ""}</td>
                            <td>${usuario.description ?? ""}</td>
                        </tr>`;
                        tabela.innerHTML += linha;
                    });
                })
                .catch(error => console.error("Erro ao buscar dados:", error));
        }

        function aplicarFiltro() {
            const nomeFiltro = document.getElementById("filterName").value.toLowerCase();
            const dataFiltro = document.getElementById("filterDate").value;

            const formattedDataFiltro = dataFiltro
                ? dataFiltro.split("-").reverse().join("/")
                : "";

            const linhas = document
                .getElementById("accessHistoryTable")
                .getElementsByTagName("tr");

            for (let i = 0; i < linhas.length; i++) {
                const colunas = linhas[i].getElementsByTagName("td");

                const dataLinha = colunas[0].textContent.trim();
                const nomeLinha = colunas[2].textContent.trim().toLowerCase();

                const correspondeNome = nomeLinha.includes(nomeFiltro);
                const correspondeData =
                    !formattedDataFiltro || dataLinha === formattedDataFiltro;

                linhas[i].style.display =
                    correspondeNome && correspondeData ? "" : "none";
            }
        }

        function resetFilter() {
            const tabela = document.getElementById("accessHistoryTable");
            const linhas = tabela.getElementsByTagName("tr");

            for (let i = 0; i < linhas.length; i++) {
                linhas[i].style.display = "";
            }

            document.getElementById("filterDate").value = "";
            document.getElementById("filterName").value = "";
        }

        carregarHistorico();

        document.getElementById("filterName").addEventListener("input", aplicarFiltro);
        document.getElementById("filterDate").addEventListener("change", aplicarFiltro);
    </script>
    <script src="../static/js/script.js"></script>
</body>

</html>